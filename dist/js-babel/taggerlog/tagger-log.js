'use strict';function _createForOfIteratorHelper(a,b){var c;if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=a[Symbol.iterator]()},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c.return||c.return()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var taggerlog=taggerlog||{};(function(a){function b(a){this.dataStore=a,this.init=function(){this.dataStore&&this.dataStore.init()},this.deleteEntry=function(a){this.dataStore&&this.dataStore.deleteEntry(a)},this.addEntry=function(a){var b=null;return this.dataStore&&(b=this.dataStore.addEntry(a)),b},this.editEntry=function(a,b,c){this.dataStore&&this.dataStore.editEntry(a,b,c)},this.getEntries=function(){this.dataStore&&this.dataStore.getEntries()},this.getTags=function(){this.dataStore&&this.dataStore.getTags()},this.saveTagCombos=function(){this.dataStore&&this.dataStore.saveTagCombos()},this.logIn=function(){this.dataStore&&this.dataStore.logIn()},this.logOut=function(){this.dataStore&&this.dataStore.logOut()}}function c(){E(),G(),z()}function d(b,c){c===void 0&&(c="entry-error");var d=b.reason,e=$("#text-entry-error-"+d).html(),f=a.tagErrorConfig[d];if(f){var g=f.data;if(g)for(var h in g)e=e.replaceAll("{"+h+"}",g[h])}var i=$("#"+c+"-alert"),j=$("#"+c+"-text");j.html(e),i.fadeTo(2e3,1e3).delay(2e3).slideUp(500)}function e(a){var b=$("#text-"+a).html(),c=$("#entry-alert"),d=$("#entry-alert-text");d.html(b),c.fadeTo(2e3,1e3).slideUp(500)}function f(a){this.reason=a}function g(b,c,e){var c=$("#add-entry-spinner"),e=$("#diary-submit"),f=b[0].reason;a.util.logError("Error adding document: "+f),c.hide(),e.prop("disabled",!1),d(b[0])}function h(b){var c=$("#edit-entry-spinner"),e=$("#edit-entry-button");a.util.logError(JSON.stringify(b)),c.hide(),e.prop("disabled",!1),d(b[0],"edit-error")}function j(){a.queryRelatedTags=[];for(var b=0<a.queryTags.length,c=0;c<a.entries.length;c++){var d=a.entries[c],e=d["tag-list"],f=!0;b&&!a.queryTags.every(function(a){return 0<=e.indexOf(a)})&&(f=!1),f&&b&&(a.queryRelatedTags=a.queryRelatedTags.concat(e))}return b&&(a.queryRelatedTags=s(a.queryRelatedTags)),a.queryRelatedTags}function k(){l(),u(),E()}function l(){for(var b="<div class=\"diary-entries\">{rows}</div>",c=$("#elem-no-entries").html(),d=$("#elem-no-entries-for-tags").html(),e="",f=0<a.queryTags.length,g=0<I.length,h=0;h<a.entries.length;h++){var j=a.entries[h],k=a.cleanTags(j["tag-list"]),l=k.join(),m=!0;if(f&&!a.queryTags.every(function(a){return 0<=k.indexOf(a)})&&(m=!1),g&&k.some(function(a){return 0<=I.indexOf(a)})&&(m=!1),m){var s="<div class=\"diary-entry\" onclick=\"taggerlog.entryClicked(event, '{entry-id}')\">\n      <div class=\"diary-entry-text\">{entry}</div>\n      <div>\n        <div class=\"row\">\n          <div class=\"diary-entry-controls col-3\"></div>\n          <div class=\"diary-entry-tags col-9 text-truncate\">{tags}</div>\n        </div>\n      </div>\n    </div>".replace("{date}",j.date);s=s.replace("{entry}",q(n(j.entry))),s=s.replace("{entry-id}",j.id),s=s.replace("{tags}",l),e+=s}}var o=0<a.queryTags.length||0<I.length;""==e&&(o?e=d:e=c);var p=b.replace("{rows}",e),r=$("#recent-entries");r.html(p),$("#recent-entries").Pullable(null,function(a,b,c){if(80>c){var d="".concat(c,"px");$(".refresh-spinner").stop(),$(".refresh-spinner").css("height",d)}},function(){$(".refresh-spinner").animate({height:"0px"},500)})}function m(a){return a=new Option(a).innerHTML,a}function n(a){return a=m(a),a}function o(a){return a=DOMPurify.sanitize(a),a=a.replace(/[\r\n\t]/g,""),a}function p(a){var b=a.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);return null!==b}function q(a){return a=a.replace(/^(http.*)$/gm,function(a){if(p(a)){var b="<a href=\"{link}\" target=\"_blank\" onclick=\"event.stopPropagation();\">{linkDisplay}</a>".replace("{link}",a);return b=b.replace("{linkDisplay}",a),b}return a}),a=a.replaceAll("*","&bull;"),a=a.replaceAll("\n","<br />"),a}function r(b){for(var c=null,d=0;d<a.entries.length&&(c=a.entries[d],c.id!==b);d++);var e=c,f=$("#edit-entry-form"),g=f.find("textarea[name=diary-entry]"),h=f.find("[name=diary-date]");g.val(e.entry);var j=e.date;h[0].valueAsNumber=j.getTime(),$("#edit-entry-button").data("id",b),$("#delete-entry-button-on-popup").data("id",b);for(var k=e["tag-list"],l=$("#elem-diary-tag-edit").html(),m="",n="",d=0;d<k.length;d++)m=l.replaceAll("{tag}",a.cleanTag(k[d])),m=m.replace("{selected}","selected"),n+=m;$("#diary-edit-entry-tags").html(n),f.find("[name=new-tag]").val(""),$("#edit-entry-date").removeClass("show"),$("#editEntryModal").on("shown.bs.modal",function(){$("#editEntryModal").find("[name=diary-entry]").focus()}),D(),$("#editEntryModal").modal()}function s(a){for(var b=new Set(a),c=Array.from(b).sort(),d=a.length-1;0<=d;d--)""==c[d]&&c.splice(d,1);return c}function t(b,c){var d=a.queryTags.indexOf(b),e=-1!=d,f=I.indexOf(b),g=-1!=f,h=a.queryTags[0];c?(e&&a.queryTags.splice(d,1),g?I.splice(f,1):I.push(b)):(!e&&!g&&a.queryTags.push(b),e&&a.queryTags.splice(d,1),g&&I.splice(f,1));var i=a.queryTags[0],l=a.entries.length&&i===h;j(),F(),l?k():a.dataStore.getEntries()}function u(){var b=$("#elem-diary-tag").html(),c=$("#elem-diary-tag-display").html(),d="",e="",f=[],g="",h=a.allTags;a.queryRelatedTags.length&&(h=a.queryRelatedTags),7<h.length-a.queryTags.length?($(".tl-header-search-container").removeClass("d-none"),J&&(h=h.filter(function(a){return a.startsWith(J.toLowerCase())}))):($(".tl-header-search-container").addClass("d-none"),F());var j=$("#elem-no-tags").html();if(a.loggedInUser){var k=a.loggedInUser.uid;v("query-tags-"+k,a.queryTags),v("exclude-tags-"+k,I)}for(var l="",m="",n=0;n<a.queryTags.length;n++)l=c.replaceAll("{tag}",a.cleanTag(a.queryTags[n])),l=l.replace("{selected}","selected"),m+=l;$("#diary-entry-active-tags").html(m);for(var p,q="",r=h.length,n=0;n<a.queryTags.length;n++)p=a.cleanTag(a.queryTags[n]),g=b.replaceAll("{tag}",p),g=g.replaceAll("{selected}","selected"),e+=g,f.push(p);for(var p,n=0;n<I.length;n++)p=a.cleanTag(I[n]),g=b.replaceAll("{tag}",a.cleanTag(p)),g=g.replaceAll("{selected}","exclude"),e+=g,f.push("!"+p);var s=f.join(",");if(f.length&&(a.tagCombos.find(function(a){return a.tags===s})?$("#star-tags-main").addClass("starred"):$("#star-tags-main").removeClass("starred")),h.length){var u,w=_createForOfIteratorHelper(h);try{for(w.s();!(u=w.n()).done;){var p=u.value;if(!(-1<a.queryTags.indexOf(p)||-1<I.indexOf(p))){var x=!a.queryTags.length&&!I.length;x&&7<r&&q&&p.charAt(0)!=q.charAt(0)&&(d+="<br />"),g=b.replaceAll("{tag}",a.cleanTag(p)),g=g.replaceAll("{selected}",""),d+=g,q=p}}}catch(a){w.e(a)}finally{w.f()}}else d=j;var y=$("#panel-all-tags").addClass("d-none"),z=$("#panel-selected-tags").addClass("d-none"),A=$("#panel-related-tags").addClass("d-none"),B=$("#diary-related-tags");e?(z.removeClass("d-none"),$("#diary-selected-tags").html(e),$("#diary-tags").html(""),d&&(A.removeClass("d-none"),B.html(d))):(y.removeClass("d-none"),$("#diary-tags").html(d));var C=$("#panel-tag-combos").addClass("d-none"),D=$("#diary-tag-combos");if(a.tagCombos.length){for(var E="",G=$("#elem-diary-tag-combos").html(),n=0;n<a.tagCombos.length;n++){var H=a.tagCombos[n].tags,K=a.tagCombos[n].title,L=G.replaceAll("{tag}",H);L=L.replaceAll("{tag-string}",o(K)),L=H===s?L.replaceAll("{active}","active"):L.replaceAll("{active}",""),E+=L}D.html(E),C.removeClass("d-none")}$(".diary-tag").HoldButton(250,function(a){var b=a.data("tag");t(b,!0)},function(a){var b=a.data("tag");t(b)})}function v(b,c){if(a.loggedInUser){var d=a.loggedInUser.uid;window.localStorage.setItem(d+b,JSON.stringify(c))}}function w(b){if(a.loggedInUser){var c=a.loggedInUser.uid;return window.localStorage.getItem(c+b)}}function x(){$("#diary-controls-toggle").removeClass("d-none").addClass("d-flex"),$("#diary-controls").removeClass("d-flex").addClass("d-none")}function y(){$("#diary-controls-toggle").addClass("d-none").removeClass("d-flex"),$("#diary-controls").removeClass("d-none").addClass("d-flex")}function z(){var b=a.loggedInUser;if($(".loading-show").addClass("d-none"),$(".loaded-show").removeClass("d-none"),a.loggedInUser){var c=a.loggedInUser.uid,d=w("query-tags-"+c),e=w("exclude-tags-"+c);d&&(a.queryTags=JSON.parse(d)),e&&(I=JSON.parse(e)),$(".logged-in-show").removeClass("d-none"),$(".logged-out-show").addClass("d-none");var f=H["default-user-img"];$("#header-user-img").on("error",function(){$(this).attr("src",H["default-user-img"])}),b.photoURL&&(f=b.photoURL),$("#header-user-img").attr("src",f),$("#header-user-name").html(b.displayName),$("#header-user-email").html(b.email),$("#diary-controls").removeClass("d-none").addClass("d-flex");var g=$("input[type=text], textarea");g.focus(function(){x()}),g.on("blur",function(){y()}),$("#diary-controls-toggle").on("click",function(a){a.stopPropagation(),y()}),a.dataStore.getEntries(),a.dataStore.getTags()}else $(".logged-in-show").addClass("d-none"),$(".logged-out-show").removeClass("d-none"),$("#diary-controls").removeClass("d-flex").addClass("d-none")}function A(a){var b=$("#"+a),c=b.find(".diary-tag"),d=[];c.each(function(){var a=$(this),b=a.data("tag");a.hasClass("exclude")&&(b="!"+b),d.push(b)});var e=d.join(",");return e}function B(b){var c=$(b),d=c.data("tag"),e=d.split(","),f=a.queryTags[0],g=!1;if(c.hasClass("active"))I=[],a.queryTags=[],c.removeClass("active"),$(".selected-tags-star").removeClass("starred");else{a.queryTags=[],I=[];for(var h,l=0;l<e.length;l++)h=e[l],h.startsWith("!")?I.push(h.substring(1)):a.queryTags.push(h);var m=a.queryTags[0];g=a.entries.length&&m===f}F(),j(),g?k():a.dataStore.getEntries()}function C(a){var b=$(a),c=b.data("countElem"),d=$("#"+c),e=b.data("entry-type"),f=[e,"max-length"].join("-"),g=H[f],h=b.val().length;d.removeClass("max warning");h>g-g/10?(d.html(h+"/"+g),d.removeClass("d-none"),h>=g?d.addClass("max"):d.addClass("warning")):d.addClass("d-none")}function D(){var b=$(".entry-count");b.on("change keyup input",function(a){C($(a.target))}),b.each(function(){var b=$(this),c="max-length",d=b.data("entryType");d&&(c=d+"-"+c);var e=a.config[c];b.attr("maxlength",e),C(this)})}function E(){var b=!1;$(".tagAutoComplete").textcomplete([{match:/(^|\b)(,*\w{1,})$/,search:function search(c,d){","===c.charAt(0)&&(b=!0),c=c.replaceAll(",","");var e=a.allTags.filter(function(a){return a.startsWith(c.toLowerCase())}),f=e.length;e=e.slice(0,5),d(e);var g=$(".textcomplete-dropdown");e.length<f&&!g.find(".textcomplete-morematches").length&&g.html(g.html()+"<li class=\"textcomplete-morematches\">...</li>")},template:function template(a){return a},replace:function replace(a){return b?(b=!1,","+a+","):a+","}}])}function F(){J="",$(".tl-header-search").val(J)}function G(){F(),$(".tl-header-search").on("input",function(){J=$(this).val().trim(),u()})}var H={"max-length":400,"combo-title-max-length":30,"default-user-img":"img/ui/default-user-1-sm.png"};a.config=H,a.entries=[],a.allTags=[],a.queryTags=[];var I=[];a.queryRelatedTags=[],a.tagCombos=[];var J="";a.json=function(a){return JSON.stringify(a)},a.dataStore=new b,a.setDataStore=function(c){a.dataStore=new b(c)},$(function(){window.AndroidInterface?a.setDataStore(window.AndroidInterface):a.setDataStore(new a.TLInterfaceFirebase(a)),a.dataStore.init()}),a.init=function(){a.entries=[],a.allTags=[],a.tagCombos=[],a.queryRelatedTags=[],I=[],a.queryTags=[],c()},a.logIn=function(){this.dataStore.logIn()},a.logOut=function(){this.dataStore.logOut()},a.setUser=function(b){a.loggedInUser=b,a.updateLoggedInUI()},a.showAlert=e,a.showAlert=e,a.diaryAddEntry=function(b){var c=a.loggedInUser,d=$("#add-entry-spinner"),h=$("#diary-submit");d.show(),h.prop("disabled",!0);var i=$(b),l=i.find("textarea[name=diary-entry]"),m=l.val().substring(0,H["max-length"]),n=i.find("[name=diary-date]").val(),o=[];m||o.push(new f("entry-empty"));var p=i.find("[name=new-tag]"),q=p.val(),r=a.tagCSVToTags(q,!1);r=r.concat(a.queryTags);var t=new a.TagVerifier(a.tagErrorConfig);if(t.verifyTags(r),t.errors.length&&(o=o.concat(t.errors)),o.length)g(o,d,h);else{r=a.cleanTags(r),r=s(r),a.allTags=a.allTags.concat(r),a.allTags=s(a.allTags);var u=new Date;n&&""!==n&&(u=new Date(n));var v={uid:c.uid,entry:m,date:u,deleted:!1,"tag-list":r};v.id=a.dataStore.addEntry(JSON.stringify(v)),a.entries.unshift(v),j(),k(),d.hide(),h.prop("disabled",!1),e("entry-added-alert"),l.val("")}},a.entryFailedUpdateUI=g,a.saveTagsRefresh=function(){a.refreshTagDisplay()},a.insertEntry=function(b,c){var d=!1;c&&(b=JSON.parse(b),b.date=new Date(b.date),b["date-modified"]=new Date(b["date-modified"]));for(var e,f=0;f<a.entries.length;f++)if(e=a.entries[f],e.id===b.id){d=!0,b.deleted?a.entries.splice(f,1):a.entries[f]=b;break}if(!d&&!b.deleted){for(var g,h=!1,f=0;f<a.entries.length;f++)if(g=a.entries[f],b.date.getTime()>=g.date.getTime()){a.entries.splice(f,0,b),h=!0;break}h||a.entries.push(b)}},a.updateQueryRelatedTags=j,a.refreshUI=k,a.refreshEntryDisplay=l;a.editEntryStart=r,a.editEntry=function(b){var c=$("#edit-entry-spinner"),d=$("#edit-entry-button");c.show(),d.prop("disabled",!0);var g=$("#edit-entry-form"),j=g.find("textarea[name=diary-entry]").val().substring(0,H["max-length"]),l=g.find("[name=diary-date]"),m=[];j||m.push(new f("entry-empty"));var n=[],o=[],p=$("#diary-edit-entry-tags").find(".diary-tag");p.each(function(){var a=$(this);a.hasClass("selected")?n.push(a.data("tag")):o.push(a.data("tag"))});var q=g.find("[name=new-tag]"),r=q.val(),t=a.tagCSVToTags(r,!1);t=t.concat(n),t=s(t);var u=new a.TagVerifier(a.tagErrorConfig);if(u.verifyTags(t),u.errors.length&&(m=m.concat(u.errors)),m.length)h(m);else{a.allTags=a.allTags.concat(t),a.allTags=s(a.allTags);var v={entry:j,"tag-list":t},w=new Date(l.val());v.date=w;for(var x=null,y=0;y<a.entries.length;y++)a.entries[y].id===b&&(x=a.entries[y]);a.dataStore.editEntry(b,a.json(x),a.json(v));for(var z,y=0;y<a.entries.length;y++)if(z=a.entries[y],z.id==b){v.id=b,v.date=w,a.entries[y]=v;break}k(),c.hide(),d.prop("disabled",!1),$("#editEntryModal").modal("hide"),e("entry-edited-alert")}},a.deleteEntryStart=function(a){$("#delete-entry-button").data("id",a),$("#editEntryModal").modal("hide"),$("#deleteEntryModal").modal()},a.deleteEntry=function(b){var c=$("#delete-entry-spinner");c.show(),a.dataStore.deleteEntry(b),e("entry-deleted-alert");for(var d,f=0;f<a.entries.length;f++)if(d=a.entries[f],d.id==b){a.entries.splice(f,1);break}l(),c.hide(),$("#deleteEntryModal").modal("hide")},a.processTagList=s,a.setAllTags=function(b){var c=[];b&&(c=s(b.split(","))),a.allTags=c,u()},a.removeTags=function(b){var c=b.split();c.length&&(a.allTags=a.allTags.filter(function(a){return!c.includes(a)}),a.queryTags=a.queryTags.filter(function(a){return!c.includes(a)}),a.saveTagsRefresh())},a.setTagCombos=function(b,c){c&&(b=JSON.parse(b)),a.tagCombos=b,u()},a.toggleTag=t,a.toggleEditTag=function(a){var b=$("#diary-tag-edit-"+a);b.hasClass("selected")?b.removeClass("selected"):b.addClass("selected")},a.refreshTagDisplay=u,a.updateLoggedInUI=z,a.toggleNewEntry=function(){var a=$("#diary-new-entry-panel"),b=$("#diary-tags-panel"),c=$("#diary-entries-panel"),d=$("#diary-control-new-entry"),e=$("#diary-control-tags");a.hasClass("collapse")?(a.removeClass("collapse"),c.removeClass("collapse"),b.addClass("collapse"),d.removeClass("inactive"),e.addClass("inactive"),$("#diary-new-entry").find("[name=diary-entry]").focus()):(a.addClass("collapse"),c.removeClass("collapse"),d.addClass("inactive")),window.scrollTo(0,0)},a.toggleTags=function(){var a=$("#diary-tags-panel"),b=$("#diary-new-entry-panel"),c=$("#diary-control-new-entry"),d=$("#diary-control-tags");a.hasClass("collapse")?(a.removeClass("collapse"),b.addClass("collapse"),c.addClass("inactive"),d.removeClass("inactive")):(a.addClass("collapse"),d.addClass("inactive")),window.scrollTo(0,0)},a.entryClicked=function(a,b){var c=$(a.target),d=c.closest(".pullable"),e=d.hasClass("pullClick");if(!e){var f=window.getSelection(),g=f.toString().length;d.data("beingPulled",!1),g||r(b)}},a.starTagsStart=function(b){var c=$(b),d=c.data("tagsElem"),e=A(d),f=a.tagCombos.find(function(a){return a.tags===e});f===void 0?($("#star-tags-modal").on("shown.bs.modal",function(){$("#star-tags-form").find("[name=title]").val("").focus(),D()}),$("#star-tags-modal").modal()):(a.tagCombos=a.tagCombos.filter(function(a){return a.tags!==e}),a.dataStore.saveTagCombos(),c.removeClass("starred"),u())},a.starTags=function(b){var c=$(b),e=c.data("tagsElem"),g=$("#"+e),h=g.find(".diary-tag"),i=$("#star-tags-form").find("[name=title").val(),j=o(i);if(i!==j)d(new f("starred-title-invalid"),"star-tags-error");else if(!i)d(new f("starred-title-empty"),"star-tags-error");else{i=j.trim().substring(0,a.config["combo-title-max-length"]);var k=[];h.each(function(){var a=$(this),b=a.data("tag");a.hasClass("exclude")&&(b="!"+b),k.push(b)});var l=k.join(",");a.tagCombos.unshift({title:i,tags:l}),c.addClass("starred"),u(),$("#star-tags-modal").modal("hide"),a.dataStore.saveTagCombos()}},a.getTagCombos=function(){return a.tagCombos},a.selectCombo=B,a.entryChanged=C,D(),E(),G()})(taggerlog);