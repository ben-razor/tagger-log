'use strict';function _createForOfIteratorHelper(a,b){var c;if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=a[Symbol.iterator]()},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c.return||c.return()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var taggerlog=taggerlog||{};(function(a){function b(a){this.dataStore=a,this.init=function(){this.dataStore&&this.dataStore.init()},this.deleteEntry=function(a){this.dataStore&&this.dataStore.deleteEntry(a)},this.addEntry=function(a){var b=null;return this.dataStore&&(b=this.dataStore.addEntry(a)),b},this.editEntry=function(a,b,c){this.dataStore&&this.dataStore.editEntry(a,b,c)},this.getEntries=function(a){this.dataStore&&this.dataStore.getEntries(a)},this.getTags=function(){this.dataStore&&this.dataStore.getTags()},this.saveTagCombos=function(){this.dataStore&&this.dataStore.saveTagCombos()},this.logIn=function(){this.dataStore&&this.dataStore.logIn()},this.logOut=function(){this.dataStore&&this.dataStore.logOut()}}function c(){F(),H(),A()}function d(){for(var b=a.gettingStartedEntries.length,c=0;c<b;c++){var d=a.gettingStartedEntries[c],e=d.text,f=d.tags,g={uid:a.loggedInUser.uid,entry:e,date:new Date(Date.now()+100*(b-c)),"tag-list":f,deleted:!1};h(g)}}function e(b,c){c===void 0&&(c="entry-error");var d=b.reason,e=$("#text-entry-error-"+d).html(),f=a.tagErrorConfig[d];if(f){var g=f.data;if(g)for(var h in g)e=e.replaceAll("{"+h+"}",g[h])}var i=$("#"+c+"-alert"),j=$("#"+c+"-text");j.html(e),i.fadeTo(2e3,1e3).delay(2e3).slideUp(500)}function f(a){var b=$("#text-"+a).html(),c=$("#entry-alert"),d=$("#entry-alert-text");d.html(b),c.fadeTo(2e3,1e3).slideUp(500)}function g(a){this.reason=a}function h(b){var c=b["tag-list"];a.allTags=a.allTags.concat(c),a.allTags=t(a.allTags),b.id=a.dataStore.addEntry(JSON.stringify(b)),a.entries.unshift(b)}function i(b,c,d){var c=$("#add-entry-spinner"),d=$("#diary-submit"),f=b[0].reason;a.util.logError("Error adding document: "+f),c.hide(),d.prop("disabled",!1),e(b[0])}function j(b){var c=$("#edit-entry-spinner"),d=$("#edit-entry-button");a.util.logError(JSON.stringify(b)),c.hide(),d.prop("disabled",!1),e(b[0],"edit-error")}function k(){a.queryRelatedTags=[];for(var b=0<a.queryTags.length,c=0;c<a.entries.length;c++){var d=a.entries[c],e=d["tag-list"],f=!0;b&&!a.queryTags.every(function(a){return 0<=e.indexOf(a)})&&(f=!1),f&&b&&(a.queryRelatedTags=a.queryRelatedTags.concat(e))}return b&&(a.queryRelatedTags=t(a.queryRelatedTags)),a.queryRelatedTags}function l(){m(),v(),F()}function m(){for(var b="<div class=\"diary-entries\">{rows}</div>",c=$("#elem-no-entries").html(),d=$("#elem-no-entries-for-tags").html(),e="",f=0<a.queryTags.length,g=0<J.length,h=0;h<a.entries.length;h++){var j=a.entries[h],k=a.cleanTags(j["tag-list"]),l=k.join(),m=!0;if(f&&!a.queryTags.every(function(a){return 0<=k.indexOf(a)})&&(m=!1),g&&k.some(function(a){return 0<=J.indexOf(a)})&&(m=!1),m){var t="<div class=\"diary-entry noselect\" onclick=\"taggerlog.entryClicked(event, '{entry-id}')\">\n      <div class=\"diary-entry-text\">{entry}</div>\n      <div>\n        <div class=\"row\">\n          <div class=\"diary-entry-controls col-3\"></div>\n          <div class=\"diary-entry-tags col-9 text-truncate\">{tags}</div>\n        </div>\n      </div>\n    </div>".replace("{date}",j.date);t=t.replace("{entry}",r(o(j.entry))),t=t.replace("{entry-id}",j.id),t=t.replace("{tags}",l),e+=t}}var n=0<a.queryTags.length||0<J.length;""==e&&(n?e=d:e=c);var p=b.replace("{rows}",e),q=$("#recent-entries");q.html(p);var s=!1;$("#recent-entries").Pullable(function(){s=!1},function(b,c,d){if(0!=!window.scrollY){if(!(80<=d)){var e="".concat(d,"px");$(".refresh-spinner").stop(),$(".refresh-spinner").css("height",e)}else if(d=80,!s){console.log("triggered!"),a.dataStore.getEntries(!0),s=!0;var f="".concat(d,"px");$(".refresh-spinner").stop(),$(".refresh-spinner").css("height",f),$(".refresh-spinner").delay(1e3).animate({height:"0px"},500)}}},function(){$(".refresh-spinner").animate({height:"0px"},500)})}function n(a){return a=new Option(a).innerHTML,a}function o(a){return a=n(a),a}function p(a){return a=DOMPurify.sanitize(a),a=a.replace(/[\r\n\t]/g,""),a}function q(a){var b=a.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);return null!==b}function r(a){return a=a.replace(/^(http.*)$/gm,function(a){if(q(a)){var b="<a href=\"{link}\" target=\"_blank\" onclick=\"event.stopPropagation();\">{linkDisplay}</a>".replace("{link}",a);return b=b.replace("{linkDisplay}",a),b}return a}),a=a.replaceAll("*","&bull;"),a=a.replaceAll("\n","<br />"),a}function s(b){for(var c=null,d=0;d<a.entries.length&&(c=a.entries[d],c.id!==b);d++);var e=c,f=$("#edit-entry-form"),g=f.find("textarea[name=diary-entry]"),h=f.find("[name=diary-date]");g.val(e.entry);var j=e.date;h[0].valueAsNumber=j.getTime(),$("#edit-entry-button").data("id",b),$("#delete-entry-button-on-popup").data("id",b);for(var k=e["tag-list"],l=$("#elem-diary-tag-edit").html(),m="",n="",d=0;d<k.length;d++)m=l.replaceAll("{tag}",a.cleanTag(k[d])),m=m.replace("{selected}","selected"),n+=m;$("#diary-edit-entry-tags").html(n),f.find("[name=new-tag]").val(""),$("#edit-entry-date").removeClass("show"),$("#editEntryModal").on("shown.bs.modal",function(){$("#editEntryModal").find("[name=diary-entry]").focus()}),E(),$("#editEntryModal").modal()}function t(a){for(var b=new Set(a),c=Array.from(b).sort(),d=a.length-1;0<=d;d--)""==c[d]&&c.splice(d,1);return c}function u(b,c){var d=a.queryTags.indexOf(b),e=-1!=d,f=J.indexOf(b),g=-1!=f,h=a.queryTags[0];c?(e&&a.queryTags.splice(d,1),g?J.splice(f,1):J.push(b)):(!e&&!g&&a.queryTags.push(b),e&&a.queryTags.splice(d,1),g&&J.splice(f,1));var i=a.queryTags[0],j=a.entries.length&&i===h;k(),G(),j?l():a.dataStore.getEntries()}function v(){var b=$("#elem-diary-tag").html(),c=$("#elem-diary-tag-display").html(),d="",e="",f=[],g="",h=a.allTags;a.queryRelatedTags.length&&(h=a.queryRelatedTags),7<h.length-a.queryTags.length?($(".tl-header-search-container").removeClass("d-none"),K&&(h=h.filter(function(a){return a.startsWith(K.toLowerCase())}))):($(".tl-header-search-container").addClass("d-none"),G());var j=$("#elem-no-tags").html();if(a.loggedInUser){var k=a.loggedInUser.uid;w("query-tags-"+k,a.queryTags),w("exclude-tags-"+k,J)}for(var l="",m="",n=0;n<a.queryTags.length;n++)l=c.replaceAll("{tag}",a.cleanTag(a.queryTags[n])),l=l.replace("{selected}","selected"),m+=l;$("#diary-entry-active-tags").html(m);for(var o,q="",r=h.length,n=0;n<a.queryTags.length;n++)o=a.cleanTag(a.queryTags[n]),g=b.replaceAll("{tag}",o),g=g.replaceAll("{selected}","selected"),e+=g,f.push(o);for(var o,n=0;n<J.length;n++)o=a.cleanTag(J[n]),g=b.replaceAll("{tag}",a.cleanTag(o)),g=g.replaceAll("{selected}","exclude"),e+=g,f.push("!"+o);var s=f.join(",");if(f.length&&(a.tagCombos.find(function(a){return a.tags===s})?$("#star-tags-main").addClass("starred"):$("#star-tags-main").removeClass("starred")),h.length){var t,v=_createForOfIteratorHelper(h);try{for(v.s();!(t=v.n()).done;){var o=t.value;if(!(-1<a.queryTags.indexOf(o)||-1<J.indexOf(o))){var x=!a.queryTags.length&&!J.length;x&&7<r&&q&&o.charAt(0)!=q.charAt(0)&&(d+="<br />"),g=b.replaceAll("{tag}",a.cleanTag(o)),g=g.replaceAll("{selected}",""),d+=g,q=o}}}catch(a){v.e(a)}finally{v.f()}}else d=j;var y=$("#panel-all-tags").addClass("d-none"),z=$("#panel-selected-tags").addClass("d-none"),A=$("#panel-related-tags").addClass("d-none"),B=$("#diary-related-tags");e?(z.removeClass("d-none"),$("#diary-selected-tags").html(e),$("#diary-tags").html(""),d&&(A.removeClass("d-none"),B.html(d))):(y.removeClass("d-none"),$("#diary-tags").html(d));var C=$("#panel-tag-combos").addClass("d-none"),D=$("#diary-tag-combos");if(a.tagCombos.length){for(var E="",F=$("#elem-diary-tag-combos").html(),n=0;n<a.tagCombos.length;n++){var H=a.tagCombos[n].tags,I=a.tagCombos[n].title,L=F.replaceAll("{tag}",H);L=L.replaceAll("{tag-string}",p(I)),L=H===s?L.replaceAll("{active}","active"):L.replaceAll("{active}",""),E+=L}D.html(E),C.removeClass("d-none")}$(".diary-tag").HoldButton(350,function(a){var b=a.data("tag");u(b,!0)},function(a){var b=a.data("tag");u(b)})}function w(b,c){if(a.loggedInUser){var d=a.loggedInUser.uid;window.localStorage.setItem(d+b,JSON.stringify(c))}}function x(b){if(a.loggedInUser){var c=a.loggedInUser.uid;return window.localStorage.getItem(c+b)}}function y(){$("#diary-controls-toggle").removeClass("d-none").addClass("d-flex"),$("#diary-controls").removeClass("d-flex").addClass("d-none")}function z(){$("#diary-controls-toggle").addClass("d-none").removeClass("d-flex"),$("#diary-controls").removeClass("d-none").addClass("d-flex")}function A(){var b=a.loggedInUser;if($(".loading-show").addClass("d-none"),$(".loaded-show").removeClass("d-none"),a.loggedInUser){var c=a.loggedInUser.uid,d=x("query-tags-"+c),e=x("exclude-tags-"+c);d&&(a.queryTags=JSON.parse(d)),e&&(J=JSON.parse(e)),$(".logged-in-show").removeClass("d-none"),$(".logged-out-show").addClass("d-none");var f=I["default-user-img"];$("#header-user-img").on("error",function(){$(this).attr("src",I["default-user-img"])}),b.photoURL&&(f=b.photoURL),$("#header-user-img").attr("src",f),$("#header-user-name").html(b.displayName),$("#header-user-email").html(b.email),$("#diary-controls").removeClass("d-none").addClass("d-flex");var g=$("input[type=text], textarea");g.focus(function(){y()}),g.on("blur",function(){z()}),$("#diary-controls-toggle").on("click",function(a){a.stopPropagation(),z()}),a.dataStore.getEntries(),a.dataStore.getTags()}else $(".logged-in-show").addClass("d-none"),$(".logged-out-show").removeClass("d-none"),$("#diary-controls").removeClass("d-flex").addClass("d-none")}function B(a){var b=$("#"+a),c=b.find(".diary-tag"),d=[];c.each(function(){var a=$(this),b=a.data("tag");a.hasClass("exclude")&&(b="!"+b),d.push(b)});var e=d.join(",");return e}function C(b){var c=$(b),d=c.data("tag"),e=d.split(","),f=a.queryTags[0],g=!1;if(c.hasClass("active"))J=[],a.queryTags=[],c.removeClass("active"),$(".selected-tags-star").removeClass("starred");else{a.queryTags=[],J=[];for(var h,j=0;j<e.length;j++)h=e[j],h.startsWith("!")?J.push(h.substring(1)):a.queryTags.push(h);var m=a.queryTags[0];g=a.entries.length&&m===f}G(),k(),g?l():a.dataStore.getEntries()}function D(a){var b=$(a),c=b.data("countElem"),d=$("#"+c),e=b.data("entry-type"),f=[e,"max-length"].join("-"),g=I[f],h=b.val().length;d.removeClass("max warning");h>g-g/10?(d.html(h+"/"+g),d.removeClass("d-none"),h>=g?d.addClass("max"):d.addClass("warning")):d.addClass("d-none")}function E(){var b=$(".entry-count");b.on("change keyup input",function(a){D($(a.target))}),b.each(function(){var b=$(this),c="max-length",d=b.data("entryType");d&&(c=d+"-"+c);var e=a.config[c];b.attr("maxlength",e),D(this)})}function F(){var b=!1;$(".tagAutoComplete").textcomplete([{match:/(^|\b)(,*\w{1,})$/,search:function search(c,d){","===c.charAt(0)&&(b=!0),c=c.replaceAll(",","");var e=a.allTags.filter(function(a){return a.startsWith(c.toLowerCase())}),f=e.length;e=e.slice(0,5),d(e);var g=$(".textcomplete-dropdown");e.length<f&&!g.find(".textcomplete-morematches").length&&g.html(g.html()+"<li class=\"textcomplete-morematches\">...</li>")},template:function template(a){return a},replace:function replace(a){return b?(b=!1,","+a+","):a+","}}])}function G(){K="",$(".tl-header-search").val(K)}function H(){G(),$(".tl-header-search").on("input",function(){K=$(this).val().trim(),v()})}var I={"max-length":400,"combo-title-max-length":30,"default-user-img":"img/ui/default-user-1-sm.png"};a.config=I,a.entries=[],a.allTags=[],a.queryTags=[];var J=[];a.queryRelatedTags=[],a.tagCombos=[];var K="";a.json=function(a){return JSON.stringify(a)},a.dataStore=new b,a.setDataStore=function(c){a.dataStore=new b(c)},$(function(){window.AndroidInterface?a.setDataStore(window.AndroidInterface):a.setDataStore(new a.TLInterfaceFirebase(a)),a.dataStore.init()}),a.init=function(b){a.entries=[],a.allTags=[],a.tagCombos=[],a.queryRelatedTags=[],J=[],a.queryTags=[],b&&d(),c()},a.logIn=function(){this.dataStore.logIn()},a.logOut=function(){this.dataStore.logOut()},a.initNewUser=d,a.setUser=function(b){a.loggedInUser=b,a.updateLoggedInUI()},a.showAlert=f,a.showAlert=f,a.diaryAddEntry=function(b){var c=a.loggedInUser,d=$("#add-entry-spinner"),e=$("#diary-submit");d.show(),e.prop("disabled",!0);var j=$(b),m=j.find("textarea[name=diary-entry]"),n=m.val().substring(0,I["max-length"]),o=j.find("[name=diary-date]").val(),p=[];n||p.push(new g("entry-empty"));var q=j.find("[name=new-tag]"),r=q.val(),s=a.tagCSVToTags(r,!1);s=s.concat(a.queryTags);var u=new a.TagVerifier(a.tagErrorConfig);if(u.verifyTags(s),u.errors.length&&(p=p.concat(u.errors)),p.length)i(p,d,e);else{s=a.cleanTags(s),s=t(s);var v=new Date;o&&""!==o&&(v=new Date(o));var w={uid:c.uid,entry:n,date:v,deleted:!1,"tag-list":s};h(w),k(),l(),d.hide(),e.prop("disabled",!1),f("entry-added-alert"),m.val("")}},a.addEntryAndTags=h,a.entryFailedUpdateUI=i,a.saveTagsRefresh=function(){a.refreshTagDisplay()},a.insertEntry=function(b,c){var d=!1;c&&(b=JSON.parse(b),b.date=new Date(b.date),b["date-modified"]=new Date(b["date-modified"]));for(var e,f=0;f<a.entries.length;f++)if(e=a.entries[f],e.id===b.id){d=!0,b.deleted?a.entries.splice(f,1):a.entries[f]=b;break}if(!d&&!b.deleted){for(var g,h=!1,f=0;f<a.entries.length;f++)if(g=a.entries[f],b.date.getTime()>=g.date.getTime()){a.entries.splice(f,0,b),h=!0;break}h||a.entries.push(b)}},a.updateQueryRelatedTags=k,a.refreshUI=l,a.refreshEntryDisplay=m;a.editEntryStart=s,a.editEntry=function(b){var c=$("#edit-entry-spinner"),d=$("#edit-entry-button");c.show(),d.prop("disabled",!0);var e=$("#edit-entry-form"),h=e.find("textarea[name=diary-entry]").val().substring(0,I["max-length"]),k=e.find("[name=diary-date]"),m=[];h||m.push(new g("entry-empty"));var n=[],o=[],p=$("#diary-edit-entry-tags").find(".diary-tag");p.each(function(){var a=$(this);a.hasClass("selected")?n.push(a.data("tag")):o.push(a.data("tag"))});var q=e.find("[name=new-tag]"),r=q.val(),s=a.tagCSVToTags(r,!1);s=s.concat(n),s=t(s);var u=new a.TagVerifier(a.tagErrorConfig);if(u.verifyTags(s),u.errors.length&&(m=m.concat(u.errors)),m.length)j(m);else{a.allTags=a.allTags.concat(s),a.allTags=t(a.allTags);var v={entry:h,"tag-list":s},w=new Date(k.val());v.date=w;for(var x=null,y=0;y<a.entries.length;y++)a.entries[y].id===b&&(x=a.entries[y]);a.dataStore.editEntry(b,a.json(x),a.json(v));for(var z,y=0;y<a.entries.length;y++)if(z=a.entries[y],z.id==b){v.id=b,v.date=w,a.entries[y]=v;break}l(),c.hide(),d.prop("disabled",!1),$("#editEntryModal").modal("hide"),f("entry-edited-alert")}},a.deleteEntryStart=function(a){$("#delete-entry-button").data("id",a),$("#editEntryModal").modal("hide"),$("#deleteEntryModal").modal()},a.deleteEntry=function(b){var c=$("#delete-entry-spinner");c.show(),a.dataStore.deleteEntry(b),f("entry-deleted-alert");for(var d,e=0;e<a.entries.length;e++)if(d=a.entries[e],d.id==b){a.entries.splice(e,1);break}m(),c.hide(),$("#deleteEntryModal").modal("hide")},a.processTagList=t,a.setAllTags=function(b){var c=[];b&&(c=t(b.split(","))),a.allTags=c,v()},a.removeTags=function(b){var c=b.split();c.length&&(a.allTags=a.allTags.filter(function(a){return!c.includes(a)}),a.queryTags=a.queryTags.filter(function(a){return!c.includes(a)}),a.saveTagsRefresh())},a.setTagCombos=function(b,c){c&&(b=JSON.parse(b)),a.tagCombos=b,v()},a.toggleTag=u,a.toggleEditTag=function(a){var b=$("#diary-tag-edit-"+a);b.hasClass("selected")?b.removeClass("selected"):b.addClass("selected")},a.refreshTagDisplay=v,a.updateLoggedInUI=A,a.toggleNewEntry=function(){var a=$("#diary-new-entry-panel"),b=$("#diary-tags-panel"),c=$("#diary-entries-panel"),d=$("#diary-control-new-entry"),e=$("#diary-control-tags");a.hasClass("collapse")?(a.removeClass("collapse"),c.removeClass("collapse"),b.addClass("collapse"),d.removeClass("inactive"),e.addClass("inactive"),$("#diary-new-entry").find("[name=diary-entry]").focus()):(a.addClass("collapse"),c.removeClass("collapse"),d.addClass("inactive")),window.scrollTo(0,0)},a.toggleTags=function(){var a=$("#diary-tags-panel"),b=$("#diary-new-entry-panel"),c=$("#diary-control-new-entry"),d=$("#diary-control-tags");a.hasClass("collapse")?(a.removeClass("collapse"),b.addClass("collapse"),c.addClass("inactive"),d.removeClass("inactive")):(a.addClass("collapse"),d.addClass("inactive")),window.scrollTo(0,0)},a.entryClicked=function(a,b){var c=$(a.target),d=c.closest(".pullable"),e=d.hasClass("pullClick");if(!e){var f=window.getSelection(),g=f.toString().length;d.data("beingPulled",!1),g||s(b)}},a.starTagsStart=function(b){var c=$(b),d=c.data("tagsElem"),e=B(d),f=a.tagCombos.find(function(a){return a.tags===e});f===void 0?($("#star-tags-modal").on("shown.bs.modal",function(){$("#star-tags-form").find("[name=title]").val("").focus(),E()}),$("#star-tags-modal").modal()):(a.tagCombos=a.tagCombos.filter(function(a){return a.tags!==e}),a.dataStore.saveTagCombos(),c.removeClass("starred"),v())},a.starTags=function(b){var c=$(b),d=c.data("tagsElem"),f=$("#"+d),h=f.find(".diary-tag"),i=$("#star-tags-form").find("[name=title").val(),j=p(i);if(i!==j)e(new g("starred-title-invalid"),"star-tags-error");else if(!i)e(new g("starred-title-empty"),"star-tags-error");else{i=j.trim().substring(0,a.config["combo-title-max-length"]);var k=[];h.each(function(){var a=$(this),b=a.data("tag");a.hasClass("exclude")&&(b="!"+b),k.push(b)});var l=k.join(",");a.tagCombos.unshift({title:i,tags:l}),c.addClass("starred"),v(),$("#star-tags-modal").modal("hide"),a.dataStore.saveTagCombos()}},a.getTagCombos=function(){return a.tagCombos},a.selectCombo=C,a.entryChanged=D,E(),F(),H()})(taggerlog);